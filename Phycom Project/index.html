<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Morse Code Monitor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <a href="#home">Morse Monitor</a>
    </div>
    <div class="nav-right">
      <a href="#monitor">Monitor</a>
      <a href="document.html">Document</a>    
    </div>
  </nav>

  <div class="content" id="monitor">
    <h1>Morse Code Monitor</h1>
    <p>Time left: <span id="timer">30</span> sec</p>
    <p>Code: <span id="morse"></span></p>
    <p>Decoded: <span id="decoded"></span></p>
    <p>Word: <span id="target"></span></p>
    <button type="button" class="btn btn-outline-success" onclick="setFirstEnterFalse()">Start!</button>
    <br>
    <br>
    <br>
    <br>
    <br>
    <img src="mos.jpg" alt="Morse Code" class="mos-img">
  </div>

  <script>
  const arduinoIP = "http://172.20.10.3"; // เปลี่ยนเป็น IP ของบอร์ดคุณ
  let gameStarted = false;
  let countdown = 30;
  let timerInterval;

  async function update() {
    try {
      const res = await fetch(`${arduinoIP}/data`);
      const data = await res.json();

      if (data.gameOver) {
        clearInterval(timerInterval);
        countdown = 30;
        document.getElementById("timer").innerText = countdown;
        document.getElementById("morse").innerText = "";
        document.getElementById("decoded").innerText = "";
        document.getElementById("target").innerText = "";
        gameStarted = false;
        return;
      }
      if (!gameStarted) return;

      document.getElementById("morse").innerText = data.morse;
      document.getElementById("decoded").innerText = data.decoded;
      document.getElementById("target").innerText = data.target;

      if (data.decoded === data.target && data.target !== "") {
        clearInterval(timerInterval);
        countdown = 30;
        document.getElementById("timer").innerText = countdown;
        await fetch(`${arduinoIP}/setTimer`);
        startCountdown();
      }

    } catch (err) {
      console.error("Connection error:", err);
    }
  }

  async function setFirstEnterFalse() {
    await fetch(`${arduinoIP}/setFirstEnter`);
    gameStarted = true;
    document.getElementById("morse").innerText = "";
    document.getElementById("decoded").innerText = "";
    document.getElementById("target").innerText = "";
    startCountdown();
  }

  function startCountdown() {
    countdown = 30;
    document.getElementById("timer").innerText = countdown;

    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
      countdown--;
      document.getElementById("timer").innerText = countdown;

      if (countdown <= 0) {
        clearInterval(timerInterval);
        gameStarted = false;
        document.getElementById("timer").innerText = 30;
        document.getElementById("morse").innerText = "";
        document.getElementById("decoded").innerText = "";
        document.getElementById("target").innerText = "";
        fetch(`${arduinoIP}/setTimer`).catch(err => console.error(err));
      }
    }, 1000);
  }

  setInterval(update, 1000);
  update();
</script>

</body>
</html>
